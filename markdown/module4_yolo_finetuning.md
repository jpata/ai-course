---
jupyter:
  jupytext:
    default_lexer: python
    text_representation:
      extension: .md
      format_name: markdown
      format_version: '1.3'
      jupytext_version: 1.18.1
  kernelspec:
    display_name: Python 3 (ipykernel)
    language: python
    name: python3
---

<!-- #region -->
# YOLO Fine-Tuning

This notebook demonstrates how to fine-tune a YOLO model on a custom dataset. The dataset was labeled automatically using the OWL2 model in the `module4_owl2_object_detection.md` notebook.

First, let's install the necessary libraries.

```python
!pip install -q ultralytics pandas pyyaml
```

Now, let's import the required libraries.
<!-- #endregion -->

```python
import os
import yaml
from ultralytics import YOLO
from PIL import Image
from IPython.display import display
import pandas as pd
```

<!-- #region -->
## Create Dataset YAML

YOLO models require a `dataset.yaml` file that specifies the dataset paths and class names. We will create this file now. The labels were generated by the OWL2 notebook and are located in `data/IDLE-OO-Camera-Traps/labels/test`. The corresponding images are in `data/IDLE-OO-Camera-Traps/data/test`.

**Note:** The `module4_owl2_object_detection.md` notebook only generates labels for a small sample of 10 images. Fine-tuning on such a small dataset will not produce a robust model, but it demonstrates the process. For better results, you should generate labels for a larger portion of the dataset.
<!-- #endregion -->

```python
dataset_config = {
    'path': '/home/joosep/ai-course/data/IDLE-OO-Camera-Traps',
    'train': 'data/test',
    'val': 'data/test',
    'names': {}
}

classes_path = '/home/joosep/ai-course/data/IDLE-OO-Camera-Traps/labels/test/classes.txt'

try:
    with open(classes_path, 'r') as f:
        classes = [line.strip() for line in f.readlines()]
        dataset_config['names'] = {i: name for i, name in enumerate(classes)}

    with open('ena24_yolo_dataset.yaml', 'w') as f:
        yaml.dump(dataset_config, f)

    print("ena24_yolo_dataset.yaml created:")
    with open('ena24_yolo_dataset.yaml', 'r') as f:
        print(f.read())
except FileNotFoundError:
    print(f"Error: '{classes_path}' not found.")
    print("Please run the 'Automatic data labelling' section of the 'module4_owl2_object_detection.md' notebook to generate labels and the classes.txt file.")

```

<!-- #region -->
## Fine-Tune YOLO Model

Now we can load a pretrained YOLO model and fine-tune it on our custom dataset. We'll use the `yolov8n.pt` model.

If the `ena24_yolo_dataset.yaml` was created successfully, we can proceed with training.
<!-- #endregion -->

```python
if os.path.exists('ena24_yolo_dataset.yaml'):
    # Load a pretrained YOLO model
    model = YOLO('yolov8n.pt')

    # Train the model
    # With a small dataset of 10 images, we'll train for a few epochs.
    results = model.train(data='ena24_yolo_dataset.yaml', epochs=10, imgsz=640)
else:
    print("Skipping training because 'ena24_yolo_dataset.yaml' was not created.")
```

<!-- #region -->
## View Results

After training, the best model is saved in the `runs/detect/train/weights/` directory. Let's load this model and run inference on one of the images used for training to verify that the model has learned.

We will select one of the 10 sample images that were labeled.

<!-- #endregion -->

```python
# Path to the directory where training runs are saved
train_dir = 'runs/detect'

# Find the latest training directory
if os.path.exists(train_dir):
    latest_train_run = max(os.listdir(train_dir), key=lambda d: os.path.getmtime(os.path.join(train_dir, d)))
    best_model_path = os.path.join(train_dir, latest_train_run, 'weights/best.pt')

    if os.path.exists(best_model_path):
        print(f"Loading fine-tuned model from: {best_model_path}")
        
        # Load the fine-tuned model
        model_finetuned = YOLO(best_model_path)

        # Get the path of one of the sample images
        base_data_path = 'data/IDLE-OO-Camera-Traps/'
        ena24_csv_path = os.path.join(base_data_path, 'ENA24-balanced.csv')
        ena24_df = pd.read_csv(ena24_csv_path)
        sample_images = ena24_df.sample(10, random_state=42)
        
        image_relative_path = sample_images.iloc[0]['filepath']
        full_image_path = os.path.join(base_data_path, 'data/test/', image_relative_path)

        print(f"Running inference on: {full_image_path}")

        # Run inference
        results = model_finetuned(full_image_path)

        # Display results
        im_array = results[0].plot()
        im = Image.fromarray(im_array[..., ::-1])
        display(im)
    else:
        print("Could not find 'best.pt' in the latest training run directory.")
else:
    print("No training runs found. Skipping inference.")

```